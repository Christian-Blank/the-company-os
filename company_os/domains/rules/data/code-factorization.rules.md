---
title: "Rule Set: Code Factorization & Shared SDK Governance"
version: 1.0
status: "Active"
owner: "OS Core Team"
last_updated: "2025-07-15T00:00:00Z"
parent_charter: "/os/domains/charters/data/repository-architecture.charter.md"
tags: ["rules","architecture","sdk","factorization","hexagonal"]
---

# Purpose
To provide deterministic guidelines for **when to promote code** from a single service into the shared `company_os_core` SDK (or another reusable module), and when to keep it **service‑local**.  The goal is to balance **developer velocity** with **system cohesion** and replayability.

# 0  Core Principles
* **0.1 Two Consumers Rule** Code is promoted only after *at least two* independent consumers exist or are firmly road‑mapped within one quarter.
* **0.2 Stable Contract** Only APIs with a reasonably stable domain model belong in the shared SDK.
* **0.3 Pure Domain Code** Shared code must be IO‑free; adapters stay with each service.
* **0.4 Avoid Premature Abstraction** Local duplication is cheaper than a wrong abstraction that slows all services.
* **0.5 Single Source of Truth** Once in the SDK, code may not be copied back into services—changes flow through version bumps.

# 1  Promotion Checklist (Mandatory)
To move a module into `company_os_core`, **all** of the following must be true:

| ID | Criterion | Verification Step |
|----|-----------|------------------|
| **P‑1** | Two real or imminent consumers | Links to code in two service directories or project briefs. |
| **P‑2** | Pure domain logic (no IO, CLI, HTTP, Temporal, LangChain, etc.) | Static import analysis shows zero adapter deps. |
| **P‑3** | API reasonably stable | ADR or decision record identifies expected change cadence ≤ quarterly. |
| **P‑4** | Tests cover ≥ 90 % | Coverage report attached to PR. |
| **P‑5** | Semantic‑version bump planned | `CHANGELOG.md` entry and version update in `pyproject.toml`. |

Promotion PRs that skip any step must link to a **Friction Signal** explaining why.

# 2  When to **keep code service‑local**

* Only one consumer exists or is foreseen.
* Business rules are still churning (prototype phase).
* Logic depends on adapter details (file paths, CLI flags, HTTP headers).
* Extracting would require additional indirection without clear gain.

In these cases, duplication is acceptable and *not* considered technical debt until a second consumer appears.

# 3  Shared SDK Structure Rules

1. **Directory** All shared code lives in `src/company_os_core/…`.
2. **Dependencies** Only other *core* modules or PyPI packages marked `runtime=true`; no optional adapter deps.
3. **Public API Surface** Export via `company_os_core.__all__`; internal helpers prefixed `_`.
4. **Immutability** Public dataclass / Pydantic fields are frozen; breaking changes require SemVer major bump.
5. **Versioning** Follow SemVer. Services pin minor version (`~=0.x`).
6. **Documentation** Every public object has a doctring & appears in autogenerated docs (`mkdocs`).

# 4  Service Local Helper Rules

* Live under `company_os_services/<service>/helpers/`.
* May import adapters of the *same* service but not of others.
* May be refactored or deleted without ADR, but changes must pass service test suite.
* If copied into a second service, open **SIG‑duplicate‑logic** within two working days.

# 5  Review & Refactor Triggers

| Trigger Type | Condition | Action |
|--------------|-----------|--------|
| **Time‑based** | Every 60 days a script lists duplicate modules across services. | Create signals for top 5 duplicates. |
| **Event‑based** | Same bug fixed in two places. | Immediate Signal; fast‑track promotion ADR. |
| **Metric‑based** | >3 breaking changes to `company_os_core` within 30 days. | Review this rule set for over‑promotion. |

# 6  Compliance & CI Gates

1. **Duplicate Detector** Static script fails CI if identical helper files exist in ≥ 2 services without open promotion ADR.
2. **SDK Contract Test** Each service’s test suite runs against latest `company_os_core` to detect breaking API changes.
3. **Version‑bump Guard** Publishing a new core version requires CHANGELOG entry + SemVer check.

# 7  Amending These Rules

* Any change to this rule set is itself a **meta‑decision** (`meta-decision` tag).
* Follow Decision System Rule 6: requires signal → decision record → migration plan → rule update.

# 8  Glossary

* **Adapter** – Code handling IO or orchestration (CLI, HTTP, Temporal, etc.).
* **Core/SDK** – Pure business logic: data models, validation, algorithms.
* **Promotion** – Moving code from service‑local to shared SDK.
* **Duplicate Detector** – CI tool that flags identical files in multiple services.

---

*Rule Set approved 2025‑07‑15 by OS Core Team.*
Save changes, commit, and let the automation begin.
